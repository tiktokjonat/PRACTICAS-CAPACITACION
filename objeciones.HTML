<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dojo de Objeciones - QA Vocal Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        
        /* CARD STYLES */
        .obj-list-item {
            background: #1e293b; border: 1px solid #334155; padding: 15px;
            cursor: pointer; transition: all 0.2s; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .obj-list-item:hover { background: #334155; }
        .obj-list-item.active { border-color: #f59e0b; background: #2a3441; border-left: 4px solid #f59e0b; }

        .interaction-card {
            background: #1e293b; border-radius: 16px; border: 1px solid #3b82f6;
            min-height: 500px; display: flex; flex-direction: column; position: relative;
            overflow: hidden;
        }

        .bot-bubble {
            background: #475569; color: #e2e8f0; padding: 15px 20px; border-radius: 20px 20px 20px 0;
            margin-bottom: 20px; max-width: 85%; align-self: flex-start;
            border-left: 4px solid #94a3b8; animation: slideInLeft 0.3s;
        }

        .user-bubble {
            background: #1e3a8a; color: white; padding: 20px; border-radius: 20px 20px 0 20px;
            margin-top: auto; align-self: flex-end; width: 100%;
            border-right: 4px solid #3b82f6; animation: slideInUp 0.3s;
        }

        .strategy-badge {
            background: #422006; color: #fcd34d; padding: 4px 12px; border-radius: 4px;
            font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em;
            border: 1px solid #f59e0b; display: inline-block; margin-bottom: 10px;
        }

        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* STATUS INDICATORS */
        .status-listening { color: #4ade80; animation: pulse 1.5s infinite; }
        .status-talking { color: #facc15; }
        .status-paused { color: #94a3b8; }
        .status-success { color: #4ade80; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <div class="flex justify-between items-center mb-4 shrink-0">
        <div>
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i class="fas fa-shield-alt text-yellow-500"></i> DOJO DE OBJECIONES
            </h1>
            <p class="text-slate-400 text-xs">Módulo Independiente - Entrenamiento de Respuesta Rápida</p>
        </div>
        
        <div class="flex gap-2">
            <button id="btnPause" onclick="togglePause()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg hidden">
                <i class="fas fa-pause mr-1"></i> PAUSAR
            </button>
            <a href="index.html" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg">
                <i class="fas fa-home mr-2"></i> Volver al Portal
            </a>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
        
        <div class="col-span-3 bg-slate-900 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-lg">
            <div class="p-4 bg-slate-800 border-b border-slate-700">
                <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest"><i class="fas fa-list-ul mr-2"></i>20 Escenarios Reales</h3>
            </div>
            <div class="overflow-y-auto flex-1 p-3 space-y-2" id="objectionList">
                </div>
        </div>

        <div class="col-span-9 flex flex-col">
            <div class="interaction-card p-8 shadow-2xl flex-1">
                
                <div class="flex justify-between items-start mb-6">
                    <div id="strategyDisplay">
                        </div>
                    <div id="statusIndicator" class="text-sm font-mono text-slate-500 flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        <i class="fas fa-circle text-[10px]"></i> ESPERANDO SELECCIÓN
                    </div>
                </div>

                <div class="flex-1 flex flex-col relative">
                    
                    <div id="botArea" class="hidden flex flex-col items-start">
                        <span class="text-xs text-slate-400 mb-1 ml-1 font-bold tracking-widest">CLIENTE (Roberto):</span>
                        <div class="bot-bubble text-xl font-medium" id="botText">...</div>
                        <button onclick="replayBot()" class="text-xs text-slate-500 hover:text-white mt-1 ml-1 transition">
                            <i class="fas fa-redo"></i> Repetir audio
                        </button>
                    </div>

                    <div id="userArea" class="hidden mt-auto">
                        <div class="flex justify-between items-end mb-2 ml-1">
                            <span class="text-xs text-blue-400 font-bold uppercase tracking-widest">Tu Respuesta Sugerida:</span>
                            <span class="text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded" id="micHint"><i class="fas fa-microphone text-blue-500"></i> Lee en voz alta para avanzar</span>
                        </div>
                        <div class="user-bubble shadow-xl">
                            <p id="advisorText" class="text-2xl font-semibold leading-relaxed">...</p>
                        </div>
                    </div>

                    <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <div class="bg-blue-900/30 p-6 rounded-full mb-4 border border-blue-500/50">
                            <i class="fas fa-dumbbell text-5xl text-blue-400"></i>
                        </div>
                        <h2 class="text-2xl text-white font-bold mb-2">Selecciona una objeción de la lista</h2>
                        <p class="text-slate-400 text-sm max-w-md">Escucha al cliente, lee la respuesta táctica en voz alta y el sistema avanzará automáticamente a la siguiente.</p>
                    </div>

                </div>

                <div class="mt-8 pt-6 border-t border-slate-700/50 flex justify-between items-center">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest bg-slate-900 px-3 py-1 rounded">
                        Objeción <span id="counter" class="text-white text-base">0</span> de 20
                    </div>
                    <button id="nextBtn" onclick="nextObjection()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition hidden flex items-center gap-2">
                        Forzar Siguiente <i class="fas fa-forward"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        const objectionsDB = [
            { t: "No tengo dinero", q: "Ahorita estoy aguja, no tengo ni un sol.", a: "Entiendo perfectamente que la situación está difícil. Sin embargo, mi intención no es afectarle, sino darle una solución que se ajuste a su realidad. No le pido el total, hagamos un abono mínimo hoy para que el sistema vea su voluntad y no pierda el descuento.", s: "Empatía + Abono Mínimo" },
            { t: "Sin trabajo", q: "Me botaron del trabajo, no tengo ingresos.", a: "Lamento mucho escuchar eso, Roberto. Justamente para que esta deuda no crezca más mientras consigue empleo, apoyémonos en algún familiar. ¿Quién lo ayuda con los gastos de casa ahora? Quizás podamos gestionar un monto pequeño con ellos.", s: "Sondeo de Terceros" },
            { t: "Fin de mes", q: "Llámame el 30 cuando me paguen.", a: "Mire Roberto, encantado de esperarlo, pero el sistema cierra esta campaña de descuento mañana mismo. Si esperamos a fin de mes, la deuda vuelve a su monto original. Para no perder esto, deje un abono hoy como señal y yo sostengo el descuento.", s: "Urgencia + Amarre" },
            { t: "Intereses altos", q: "Es un abuso lo que cobran de intereses.", a: "Comprendo su molestia, los números asustan. Pero justamente por eso lo llamo: mi trabajo hoy es ELIMINAR esos intereses. Con esta propuesta, usted se olvida del cobro extra y paga incluso menos del capital inicial. Aprovechemos esto.", s: "Amortiguación + Solución" },
            { t: "Es estafa", q: "No confío, seguro es estafa.", a: "Hace muy bien en desconfiar, hay que cuidar el dinero. Por eso, no me deposite a mí. Todo el trámite es directo en ventanilla del banco o en su app oficial con su DNI. Yo solo le doy el código de descuento. ¿Le dicto para que lo verifique?", s: "Validación + Seguridad" },
            { t: "Monto muy alto", q: "Esos 3 mil soles son impagables.", a: "Entiendo que de golpe es fuerte. Pero piense que es la única forma de borrar una deuda de 10 mil. Si lo dejamos pasar, el problema será el triple. ¿Qué monto tiene a la mano ahora para ver si puedo ayudarle a pisar la oferta?", s: "Comparación Costo/Beneficio" },
            { t: "Tengo hijos", q: "Tengo 4 hijos que mantener, no me alcanza.", a: "La familia es lo primero, lo entiendo. Pero piense que al limpiar su historial hoy, mañana tendrá las puertas abiertas de los bancos para pedir préstamos para ellos si lo necesita. Es una inversión en su tranquilidad futura.", s: "Beneficio Emocional" },
            { t: "Enfermedad", q: "Estoy gastando todo en medicinas.", a: "La salud es prioridad. Pero no deje que el banco se vuelva otro dolor de cabeza. Hagamos un pago simbólico para congelar la cobranza y que no lo sigan llamando mientras se recupera.", s: "Alivio de Presión" },
            { t: "Ya pagué", q: "Yo ya pagué eso hace días.", a: "¡Qué buena noticia! Para actualizar el sistema y que dejen de llamarlo, por favor envíeme la foto del voucher al WhatsApp ahora mismo. Así yo lo reporto y cerramos el caso hoy.", s: "Gestión de Evidencia" },
            { t: "No es mi deuda", q: "Ese es mi hermano, él no vive acá.", a: "Entiendo. Por favor, avísele urgente que el banco le ha dado un descuento final solo por hoy. Si no lo toma, pasará a cobranza judicial. ¿Tiene otro número donde ubicarlo para ayudarle?", s: "Sentido de Urgencia (Tercero)" },
            { t: "Me voy a quejar", q: "Ya me tienen harto, los voy a denunciar.", a: "Mi intención es ayudarle, no molestarle. Justamente quiero solucionar esto hoy para que su número salga de la lista de cobranza definitiva. Escuche la propuesta y si no le sirve, no lo llamo más.", s: "Negociación de Paz" },
            { t: "Quincena", q: "Hasta la quincena no tengo ni un sol.", a: "Entiendo, pero la campaña vence en 48 horas. Si no pone un abono de intención hoy, el sistema asume que no le interesa y le quita el beneficio. ¿Puede conseguir 50 soles para separar el cupo?", s: "Miedo a la Pérdida" },
            { t: "Banco malo", q: "Ese banco nunca me ayudó.", a: "Lamento esa mala experiencia. Hoy estoy aquí para cambiar eso. Esta campaña es justamente para clientes que tuvieron problemas. Es la oportunidad de cerrar el capítulo con el banco pagando lo mínimo.", s: "Nuevo Comienzo" },
            { t: "Abogado", q: "Hablen con mi abogado, no conmigo.", a: "Si pasamos a legal, perderá este descuento y tendrá que pagar honorarios de abogado. Es mejor arreglarlo en etapa pre-judicial con este monto reducido. Evítese gastos extras.", s: "Ahorro de Costos" },
            { t: "De viaje", q: "Estoy de viaje, regreso el lunes.", a: "No hay problema, puede usar el aplicativo móvil o un agente donde esté. Si espera al lunes, la campaña habrá caducado. Aseguremos el descuento hoy con una transferencia simple.", s: "Facilidad Digital" },
            { t: "Infocorp", q: "Ya estoy en rojo, ya qué importa.", a: "Aún puede salir. Con este pago de 'Campaña Castigo', su calificación cambia a 'Deuda Cancelada' en 48 horas. Eso le permite volver a sacar tarjetas o créditos en poco tiempo.", s: "Rehabilitación Financiera" },
            { t: "No quiero", q: "No voy a pagar, hagan lo que quieran.", a: "Roberto, no tome una decisión en caliente. Un embargo o un juicio le saldrá más caro que aprovechar este descuento del 70%. Piénselo, es mejor cerrar esto por las buenas hoy.", s: "Consecuencia Lógica" },
            { t: "Solo una parte", q: "Solo tengo 500 soles, tómalo o déjalo.", a: "Valoro su intención. El sistema pide 3,000, pero ingresemos esos 500 hoy mismo como pago a cuenta. Con eso demuestro su voluntad y peleo para que le respeten el descuento por el saldo restante.", s: "Validación Parcial" },
            { t: "Sin boleta", q: "Trabajo el día a día, no tengo boleta.", a: "No se preocupe, para este convenio no pedimos sustento de ingresos. Solo necesitamos su voluntad de pago. El banco confía en su palabra si hacemos el abono hoy.", s: "Eliminación de Barreras" },
            { t: "Muy lejos", q: "El banco me queda muy lejos.", a: "Tiene un Agente o una Bodega cerca? Ahí también puede pagar con este código. O desde su celular. No necesita ir hasta la agencia, le doy las facilidades para que lo haga en 5 minutos.", s: "Cercanía" }
        ];

        let currentIndex = -1;
        let recognition;
        let synth = window.speechSynthesis;
        let isTransitioning = false; 
        let isPaused = false;
        let pendingTransition = false; // Guarda si se pausó justo antes de avanzar

        window.onload = () => {
            renderList();
            initRecognition();
        };

        function renderList() {
            const list = document.getElementById('objectionList');
            list.innerHTML = objectionsDB.map((obj, i) => `
                <div onclick="selectObjection(${i})" class="obj-list-item" id="item-${i}">
                    <div>
                        <div class="text-xs text-slate-400 font-bold mb-1 tracking-wider">OBJECIÓN ${i+1}</div>
                        <div class="text-white font-medium text-sm">"${obj.t}"</div>
                    </div>
                    <i class="fas fa-play-circle text-slate-500 group-hover:text-blue-400"></i>
                </div>
            `).join('');
        }

        // --- LÓGICA DE PAUSA INTELIGENTE ---
        function togglePause() {
            if (currentIndex === -1) return; // Nada que pausar si no ha empezado

            const btn = document.getElementById('btnPause');
            const status = document.getElementById('statusIndicator');

            if (!isPaused) {
                // ACTIVAR PAUSA
                isPaused = true;
                if(synth.speaking) synth.pause();
                if(recognition) recognition.stop();
                
                btn.innerHTML = '<i class="fas fa-play mr-1"></i> CONTINUAR';
                btn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg";
                
                status.className = "text-sm font-mono text-slate-400 flex items-center gap-2 status-paused bg-slate-800 px-3 py-1 rounded-full border border-slate-600";
                status.innerHTML = `<i class="fas fa-pause"></i> ENTRENAMIENTO PAUSADO`;
                
                document.getElementById('objectionList').style.pointerEvents = 'none';
                document.getElementById('objectionList').style.opacity = '0.5';

            } else {
                // DESACTIVAR PAUSA
                isPaused = false;
                btn.innerHTML = '<i class="fas fa-pause mr-1"></i> PAUSAR';
                btn.className = "bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg";
                
                document.getElementById('objectionList').style.pointerEvents = 'auto';
                document.getElementById('objectionList').style.opacity = '1';

                // Reanudar acciones pendientes
                if(synth.paused) {
                    synth.resume();
                    status.className = "text-sm font-mono text-yellow-500 flex items-center gap-2 status-talking bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    status.innerHTML = `<i class="fas fa-volume-up"></i> CLIENTE HABLANDO...`;
                } else if (pendingTransition) {
                    // Si se pausó justo en los 2 seg de transición
                    pendingTransition = false;
                    nextObjection();
                } else if (!synth.speaking) {
                    // Volver a escuchar al asesor
                    try { recognition.start(); } catch(e) {}
                    status.className = "text-sm font-mono text-green-400 flex items-center gap-2 status-listening bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    status.innerHTML = `<i class="fas fa-microphone"></i> TU TURNO (LEE EL GUION)`;
                }
            }
        }

        function selectObjection(index) {
            if(isPaused) return; 
            
            isTransitioning = false;
            pendingTransition = false;
            if(recognition) recognition.stop();

            document.getElementById('btnPause').classList.remove('hidden');

            document.querySelectorAll('.obj-list-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`item-${index}`).classList.add('active');
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('botArea').classList.remove('hidden');
            document.getElementById('userArea').classList.add('hidden'); 
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('micHint').innerHTML = '<i class="fas fa-microphone text-blue-500"></i> Lee en voz alta para avanzar';

            currentIndex = index;
            document.getElementById('counter').innerText = index + 1;
            const data = objectionsDB[index];

            document.getElementById('strategyDisplay').innerHTML = `<span class="strategy-badge"><i class="fas fa-bolt text-yellow-500 mr-1"></i> TÉCNICA: ${data.s}</span>`;
            document.getElementById('botText').innerText = `"${data.q}"`;
            document.getElementById('advisorText').innerText = `"${data.a}"`;
            
            playBotAudio(data.q);
        }

        function playBotAudio(text) {
            if(synth.speaking) synth.cancel();
            
            const status = document.getElementById('statusIndicator');
            status.className = "text-sm font-mono text-yellow-500 flex items-center gap-2 status-talking bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
            status.innerHTML = `<i class="fas fa-volume-up"></i> CLIENTE HABLANDO...`;

            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'es-US'; 
            utter.rate = 1.1;

            utter.onend = () => {
                if(isPaused) return; 

                document.getElementById('userArea').classList.remove('hidden');
                status.className = "text-sm font-mono text-green-400 flex items-center gap-2 status-listening bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                status.innerHTML = `<i class="fas fa-microphone"></i> TU TURNO (LEE EL GUION)`;
                
                try { recognition.start(); } catch(e) {}
            };

            synth.speak(utter);
        }

        function replayBot() {
            if(currentIndex >= 0 && !isPaused) playBotAudio(objectionsDB[currentIndex].q);
        }

        function initRecognition() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return;
            
            recognition = new Speech();
            recognition.lang = 'es-PE';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                if(isTransitioning || isPaused) return;

                let transcript = '';
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        transcript = event.results[i][0].transcript;
                        isFinal = true;
                    }
                }

                // Si detecta una frase final de longitud razonable, asume que respondió
                if (isFinal && transcript.trim().length > 10) {
                    isTransitioning = true;
                    recognition.stop(); 

                    const hint = document.getElementById('micHint');
                    hint.innerHTML = `<span class='text-green-400 font-bold'><i class="fas fa-check"></i> ¡Excelente! Pasando al siguiente...</span>`;
                    
                    document.getElementById('statusIndicator').className = "text-sm font-mono text-blue-400 flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    document.getElementById('statusIndicator').innerHTML = `<i class="fas fa-spinner fa-spin"></i> PROCESANDO...`;

                    // Espera 2 segundos antes de avanzar
                    setTimeout(() => {
                        if(!isPaused) {
                            nextObjection();
                        } else {
                            pendingTransition = true; // Guarda el avance pendiente si pausó
                        }
                    }, 2000);
                    
                } else if (!isFinal) {
                    document.getElementById('micHint').innerHTML = "<span class='text-yellow-400'><i class='fas fa-assistive-listening-systems'></i> Escuchando...</span>";
                }
            };
            
            recognition.onend = () => {
                // Auto-reiniciar si el mic se corta solo y no estamos en transición/pausa
                if (!isTransitioning && !isPaused && currentIndex !== -1 && !synth.speaking) {
                    try { recognition.start(); } catch(e) {}
                }
            };
        }

        function nextObjection() {
            if(isPaused) return;
            let next = currentIndex + 1;
            if(next >= objectionsDB.length) next = 0; 
            
            selectObjection(next);
            
            // Auto-scroll sidebar para mantener visible la objeción actual
            const item = document.getElementById(`item-${next}`);
            if(item) item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

    </script>
</body>
</html>