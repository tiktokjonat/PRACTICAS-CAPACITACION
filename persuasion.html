<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Persuasión - QA Vocal Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        
        /* CARD STYLES */
        .obj-list-item {
            background: #1e293b; border: 1px solid #334155; padding: 15px;
            cursor: pointer; transition: all 0.2s; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .obj-list-item:hover { background: #334155; }
        /* Tono Púrpura para Persuasión */
        .obj-list-item.active { border-color: #a855f7; background: #3b0764; border-left: 4px solid #c084fc; }

        .interaction-card {
            background: #1e293b; border-radius: 16px; border: 1px solid #a855f7;
            min-height: 500px; display: flex; flex-direction: column; position: relative;
            overflow: hidden;
        }

        .bot-bubble {
            background: #334155; color: #e2e8f0; padding: 15px 20px; border-radius: 20px 20px 20px 0;
            margin-bottom: 20px; max-width: 85%; align-self: flex-start;
            border-left: 4px solid #94a3b8; animation: slideInLeft 0.3s;
        }

        .user-bubble {
            background: #581c87; color: white; padding: 20px; border-radius: 20px 20px 0 20px;
            margin-top: auto; align-self: flex-end; width: 100%;
            border-right: 4px solid #c084fc; animation: slideInUp 0.3s;
        }

        .strategy-badge {
            background: #2e1065; color: #e879f9; padding: 4px 12px; border-radius: 4px;
            font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em;
            border: 1px solid #a855f7; display: inline-block; margin-bottom: 10px;
        }

        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* STATUS INDICATORS */
        .status-listening { color: #c084fc; animation: pulse 1.5s infinite; }
        .status-talking { color: #facc15; }
        .status-paused { color: #94a3b8; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .mode-tab {
            padding: 10px 20px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;
            color: #94a3b8; flex: 1; text-align: center;
        }
        .mode-tab.active {
            color: #c084fc; border-bottom-color: #c084fc; background: rgba(192, 132, 252, 0.1);
        }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <div class="flex justify-between items-center mb-4 shrink-0">
        <div>
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i class="fas fa-brain text-purple-400"></i> LABORATORIO DE PERSUASIÓN
            </h1>
            <p class="text-slate-400 text-xs">Manejo de Leyes de Influencia Psicológica</p>
        </div>
        
        <div class="flex gap-2">
            <button id="btnPause" onclick="togglePause()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg hidden">
                <i class="fas fa-pause mr-1"></i> PAUSAR
            </button>
            <a href="index.html" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg">
                <i class="fas fa-home mr-2"></i> Volver al Portal
            </a>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
        
        <div class="col-span-3 bg-slate-900 rounded-xl border border-slate-700 flex flex-col overflow-hidden shadow-lg">
            <div class="p-4 bg-slate-800 border-b border-slate-700">
                <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest"><i class="fas fa-magnet mr-2"></i>30 Escenarios de Cialdini</h3>
            </div>
            <div class="overflow-y-auto flex-1 p-3 space-y-2" id="objectionList">
                </div>
        </div>

        <div class="col-span-9 flex flex-col">
            
            <div class="flex bg-slate-800 rounded-lg overflow-hidden border border-slate-700 w-full md:w-fit mb-4">
                <div id="tabReading" class="mode-tab active" onclick="setMode('reading')">
                    <i class="fas fa-book-open mr-2"></i> Lectura Guiada
                </div>
                <div id="tabFree" class="mode-tab" onclick="setMode('free')">
                    <i class="fas fa-microphone-alt mr-2"></i> Modo Libre
                </div>
            </div>

            <div class="interaction-card p-8 shadow-2xl flex-1">
                
                <div class="flex justify-between items-start mb-6">
                    <div id="strategyDisplay">
                        </div>
                    <div id="statusIndicator" class="text-sm font-mono text-slate-500 flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        <i class="fas fa-circle text-[10px]"></i> ESPERANDO INICIO
                    </div>
                </div>

                <div class="flex-1 flex flex-col relative">
                    
                    <div id="botArea" class="hidden flex flex-col items-start">
                        <span class="text-xs text-slate-400 mb-1 ml-1 font-bold tracking-widest">CLIENTE (Roberto):</span>
                        <div class="bot-bubble text-xl font-medium" id="botText">...</div>
                        <button onclick="replayBot()" class="text-xs text-slate-500 hover:text-purple-400 mt-1 ml-1 transition">
                            <i class="fas fa-redo"></i> Repetir comentario
                        </button>
                    </div>

                    <div id="userArea" class="hidden mt-auto">
                        <div class="flex justify-between items-end mb-2 ml-1">
                            <span class="text-xs text-purple-400 font-bold uppercase tracking-widest" id="userLabel">Tu Respuesta Persuasiva:</span>
                            <span class="text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded" id="micHint"><i class="fas fa-microphone text-purple-500"></i> Lee en voz alta</span>
                        </div>
                        <div class="user-bubble shadow-xl" id="advisorBox">
                            <p id="advisorText" class="text-2xl font-semibold leading-relaxed">...</p>
                        </div>
                    </div>

                    <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <div class="bg-purple-900/30 p-6 rounded-full mb-4 border border-purple-500/50">
                            <i class="fas fa-brain text-5xl text-purple-400"></i>
                        </div>
                        <h2 class="text-2xl text-white font-bold mb-2">Entrenamiento de Persuasión</h2>
                        <p class="text-slate-400 text-sm max-w-md mb-6">Domina las leyes de la influencia para revertir negativas, quejas y excusas.</p>
                        <button id="btnStart" onclick="startSystem()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition">
                            COMENZAR ENTRENAMIENTO
                        </button>
                    </div>

                </div>

                <div class="mt-8 pt-6 border-t border-slate-700/50 flex justify-between items-center">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest bg-slate-900 px-3 py-1 rounded">
                        Escenario <span id="counter" class="text-white text-base">0</span> de 30
                    </div>
                    <button id="nextBtn" onclick="nextObjection()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition hidden flex items-center gap-2">
                        Forzar Siguiente <i class="fas fa-forward"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PERSUASIÓN (30 Escenarios) ---
        const persuasionDB = [
            // RECIPROCIDAD (Dar algo primero para generar compromiso)
            { t: "Reciprocidad 1", c: "Exoneración de Intereses", q: "Es que no sé si pueda pagar hoy, déjame ver si consigo y te aviso.", a: "Señor Roberto, he gestionado personalmente con mi supervisor una exoneración del 100% de sus intereses moratorios para que pueda ponerse al día. Dado que he conseguido este gran beneficio para usted, ¿podría realizar el abono hoy mismo?", keywords: ["gestionado", "supervisor", "exoneración", "beneficio", "hoy"], s: "Técnica de Reciprocidad" },
            { t: "Reciprocidad 2", c: "Extensión de Plazo", q: "Ahorita no puedo ir al banco, estoy trabajando todo el día.", a: "Lo entiendo. Acabo de hablar con el área de sistemas y logré que le extiendan el plazo de pago hasta el fin de semana. Como le he conseguido estos días extra de gracia, ¿puedo registrar su compromiso de abono para el sábado a primera hora?", keywords: ["sistemas", "logré", "fin", "semana", "gracia", "compromiso", "sábado"], s: "Técnica de Reciprocidad" },
            { t: "Reciprocidad 3", c: "Frenar Reporte", q: "Déjame ver qué puedo hacer, llámame la otra semana a ver si tengo algo.", a: "Para ayudarle, he paralizado momentáneamente el reporte negativo a Infocorp de este mes. Ya que yo estoy frenando esto por mi cuenta, necesito que usted me apoye realizando un pago mínimo hoy para justificar esta retención en el sistema.", keywords: ["paralizado", "reporte", "infocorp", "frenando", "apoye", "mínimo", "justificar"], s: "Técnica de Reciprocidad" },
            { t: "Reciprocidad 4", c: "Bajar Cuota", q: "Las cuotas que me ofrecen son muy altas, no me alcanza mi sueldo.", a: "Me he tomado el tiempo de reestructurar su plan de pagos y logré bajarle la cuota a la mitad. Ya que he ajustado el monto a exactamente lo que usted pidió, ¿con cuánto cerramos la primera cuota en este momento?", keywords: ["tiempo", "reestructurar", "bajarle", "cuota", "mitad", "ajustado", "cerramos"], s: "Técnica de Reciprocidad" },
            { t: "Reciprocidad 5", c: "Trámite de Carta", q: "¿Y cómo sé que ya no les deberé nada después de pagar?", a: "Le garantizo total seguridad. Es más, yo mismo me encargaré de tramitar y enviarle su Carta de No Adeudo sin ningún costo. A cambio de esta gestión directa de mi parte, necesito que aseguremos el pago ahora mismo.", keywords: ["garantizo", "mismo", "carta", "adeudo", "costo", "gestión", "pago"], s: "Técnica de Reciprocidad" },

            // ESCASEZ (Miedo a perder, límite de tiempo o cupos)
            { t: "Escasez 1", c: "Cupos Limitados", q: "Me parece bien el descuento, pero guárdamelo para el viernes.", a: "Esta campaña de descuento es exclusiva solo para los primeros 10 clientes del día y vence mañana a las 10 de la mañana. Si no aprovechamos este cupo ahora, el sistema volverá a cargarle la deuda total y perderá la oferta.", keywords: ["campaña", "exclusiva", "primeros", "vence", "cupo", "total"], s: "Técnica de Escasez" },
            { t: "Escasez 2", c: "Cierre de Mes", q: "Llámame en la quincena que me pagan mi sueldo.", a: "El problema es que esta condonación de intereses es una política de cierre de mes y expira definitivamente hoy a las 6 de la tarde. Si esperamos a la quincena, perderá este 50% de descuento que es irrepetible.", keywords: ["condonación", "política", "cierre", "expira", "definitivamente", "perderá"], s: "Técnica de Escasez" },
            { t: "Escasez 3", c: "Pase Legal", q: "Ahí voy a ir viendo cómo consigo la plata de a pocos.", a: "Señor Roberto, el tiempo juega en contra. Su cuenta está programada para pasar al estudio jurídico mañana. Esta es la última llamada que recibirá del banco para conciliar con descuento. Mañana ya será muy tarde.", keywords: ["tiempo", "contra", "cuenta", "estudio", "jurídico", "última", "tarde"], s: "Técnica de Escasez" },
            { t: "Escasez 4", c: "Válido en Llamada", q: "Tengo que consultarlo con mi esposa, te corto y te aviso.", a: "Entiendo, pero debo informarle que esta anulación de moras solo es válida durante el transcurso de esta llamada telefónica. Si usted cuelga sin darme un compromiso, el sistema anulará la oferta y no podré recuperarla.", keywords: ["anulación", "moras", "válida", "durante", "llamada", "cuelga", "anulará"], s: "Técnica de Escasez" },
            { t: "Escasez 5", c: "Acción Preventiva", q: "No creo que me hagan nada por esta deuda tan pequeña.", a: "Ese es un error común. Actualmente, su expediente está en el lote de embargos preventivos que se procesan este mismo viernes. Es su última oportunidad y plazo final para frenar esa orden con un abono inmediato.", keywords: ["expediente", "lote", "embargos", "viernes", "última", "oportunidad", "frenar"], s: "Técnica de Escasez" },

            // AUTORIDAD (Posicionamiento experto, consecuencias reales)
            { t: "Autoridad 1", c: "Impacto Crediticio", q: "Ustedes solo llaman para molestar, ya les dije que no tengo plata.", a: "Como asesor especialista en recuperación de cartera, mi deber es advertirle que esto afectará permanentemente su historial crediticio, impidiéndole acceder a préstamos o servicios en el futuro. Es urgente solucionarlo.", keywords: ["asesor", "especialista", "deber", "advertirle", "historial", "impidiéndole", "urgente"], s: "Técnica de Autoridad" },
            { t: "Autoridad 2", c: "Palabra Final", q: "Ese descuento es muy poco, quiero que me bajen más la cuenta.", a: "Señor, soy el Supervisor de la Unidad de Negociaciones Especiales. Le aseguro que he revisado su caso personalmente y este es el descuento máximo legal permitido por la gerencia del banco. No habrá otra oferta.", keywords: ["supervisor", "unidad", "especiales", "revisado", "personalmente", "máximo", "permitido", "gerencia"], s: "Técnica de Autoridad" },
            { t: "Autoridad 3", c: "Proceso Pre-Judicial", q: "Manden los papeles a donde quieran, no voy a pagar nada.", a: "Le hablo desde el Departamento Pre-Judicial. Si usted omite este requerimiento de pago hoy, procederemos con la ejecución de garantías y la notificación a su empleador, según las cláusulas que usted mismo firmó.", keywords: ["departamento", "prejudicial", "ejecución", "garantías", "notificación", "empleador", "cláusulas"], s: "Técnica de Autoridad" },
            { t: "Autoridad 4", c: "Impacto Laboral", q: "Me da igual Infocorp, nunca saco préstamos.", a: "Como analista de riesgo, le informo que una mala calificación hoy en día no solo bloquea créditos. Las grandes empresas revisan Infocorp antes de contratar personal, y también le bloquea sacar planes postpago de celular.", keywords: ["analista", "riesgo", "informo", "bloquea", "empresas", "revisan", "contratar"], s: "Técnica de Autoridad" },
            { t: "Autoridad 5", c: "Base Legal", q: "El interés me parece un robo total, no es mi culpa.", a: "Como experto financiero del banco, le explico que esa tasa fue aceptada legalmente por usted al momento del desembolso, según regulación de la SBS. Hoy le estoy dando la vía legal para anular esos cobros, tómela.", keywords: ["experto", "financiero", "tasa", "aceptada", "desembolso", "regulación", "sbs", "legal"], s: "Técnica de Autoridad" },

            // CONSISTENCIA (Recordarle su buena identidad pasada para que cumpla)
            { t: "Consistencia 1", c: "Historial Positivo", q: "La verdad ya no me importa estar en rojo, déjenlo así nomás.", a: "Señor Roberto, revisando su historial veo que usted siempre fue un cliente muy cumplido y confiable. Usted siempre mantuvo un perfil impecable con nosotros; por eso, queremos que mantenga esa consistencia solucionando esto hoy.", keywords: ["historial", "siempre", "cumplido", "confiable", "perfil", "consistencia", "mantenga"], s: "Técnica de Consistencia" },
            { t: "Consistencia 2", c: "Antigüedad", q: "No pienso pagar porque me han tratado mal en la agencia.", a: "Entiendo su frustración. Pero usted tiene más de 5 años trabajando con el banco y siempre ha sido muy responsable con sus productos. No manche esos 5 años de impecable relación financiera por este pequeño retraso.", keywords: ["años", "trabajando", "siempre", "responsable", "productos", "manche", "relación"], s: "Técnica de Consistencia" },
            { t: "Consistencia 3", c: "Responsabilidad de Firma", q: "Ese crédito fue para mi hijo, no para mí, que él lo pague.", a: "Comprendo el contexto familiar, pero usted, siendo una persona de palabra, fue quien puso su firma y respaldo. El banco le confió el dinero a usted por su excelente comportamiento. Honre esa firma cerrando la deuda hoy.", keywords: ["contexto", "persona", "palabra", "firma", "respaldo", "confió", "honre"], s: "Técnica de Consistencia" },
            { t: "Consistencia 4", c: "Acuerdo Previo", q: "Te dije la semana pasada que no sé cuándo podré pagar.", a: "La semana pasada usted mismo me indicó que tenía toda la intención de regularizar la deuda porque quiere estar tranquilo. Guiado por esa voluntad que usted me demostró, hoy le traigo la campaña perfecta para lograrlo.", keywords: ["semana", "pasada", "mismo", "intención", "regularizar", "voluntad", "demostró"], s: "Técnica de Consistencia" },
            { t: "Consistencia 5", c: "Identidad Honesta", q: "Ya hagan lo que quieran, no me importa.", a: "Por el tono de su voz, sé que usted es una persona trabajadora y honesta a la cual simplemente se le complicaron las cosas. Una persona honesta no huye de sus problemas, los enfrenta. Yo estoy aquí para ayudarle a enfrentarlo.", keywords: ["tono", "voz", "trabajadora", "honesta", "complicaron", "huye", "enfrenta"], s: "Técnica de Consistencia" },

            // AGRADO / EMPATÍA (Crear conexión, ponerse de su lado)
            { t: "Agrado 1", c: "Empatía Económica", q: "Es fácil cobrar, pero ustedes no saben lo que es no tener para darle de comer a los hijos.", a: "Señor Roberto, lo entiendo perfectamente porque yo también he pasado por situaciones difíciles similares. Sé lo que es priorizar gastos en casa, y precisamente porque lo comprendo, voy a mover cielo y tierra para ayudarle hoy.", keywords: ["entiendo", "perfectamente", "también", "pasado", "difíciles", "priorizar", "ayudarle"], s: "Técnica de Agrado" },
            { t: "Agrado 2", c: "Salud / Enfermedad", q: "Me he operado y todo mi dinero se fue a la clínica.", a: "Lamento muchísimo escuchar sobre su salud, espero de corazón que se recupere pronto. La salud siempre es primero. Para quitarle esta preocupación de encima y que descanse tranquilo, permítame acomodar el pago en cuotas súper bajas.", keywords: ["lamento", "muchísimo", "salud", "corazón", "recupere", "preocupación", "descanse"], s: "Técnica de Agrado" },
            { t: "Agrado 3", c: "Disculpas por mal trato", q: "En la agencia me trataron pésimo, son unos abusivos.", a: "Le pido sinceras disculpas a nombre del banco por ese mal rato. A nadie le gusta que lo traten mal. Afortunadamente usted ahora está hablando conmigo, y yo me voy a encargar personalmente de que tenga el mejor trato y descuento.", keywords: ["disculpas", "nombre", "mal", "rato", "gusta", "afortunadamente", "personalmente"], s: "Técnica de Agrado" },
            { t: "Agrado 4", c: "Exceso de llamadas", q: "Me llaman 20 veces al día, ya me tienen harto.", a: "Le doy toda la razón, sé lo molestoso que es recibir tantas llamadas en horas de trabajo. Mi intención no es sumar estrés a su día, sino al contrario, darle una salida definitiva para que mi sistema bloquee esas llamadas desde hoy.", keywords: ["razón", "molestoso", "recibir", "trabajo", "estrés", "definitiva", "bloquee"], s: "Técnica de Agrado" },
            { t: "Agrado 5", c: "Crisis Nacional", q: "Con esta crisis y la falta de trabajo, nadie tiene plata.", a: "Totalmente de acuerdo con usted, la economía está muy golpeada y todos lo sentimos en nuestros bolsillos. Justamente porque el banco es consciente de esta dura realidad, hemos habilitado este bono de crisis para que cancele fácil.", keywords: ["totalmente", "acuerdo", "economía", "golpeada", "bolsillos", "consciente", "realidad"], s: "Técnica de Agrado" },

            // CONSENSO / PRUEBA SOCIAL (Mostrar que otros ya lo hicieron con éxito)
            { t: "Consenso 1", c: "Miedo a las cuotas", q: "No sé si meterme en cuotas, me da miedo no poder cumplir y endeudarme peor.", a: "Muchos clientes que estaban en una situación similar a la suya optaron por el pago en cuotas y hoy ya recuperaron su tranquilidad financiera y su acceso a crédito. Es el paso más seguro que todos están tomando.", keywords: ["muchos", "clientes", "situación", "similar", "optaron", "cuotas", "recuperaron", "seguro"], s: "Técnica de Consenso" },
            { t: "Consenso 2", c: "Desconfianza digital", q: "Es que no confío en pagar por esos enlaces o aplicativos de internet.", a: "Es normal tener precaución. Le comento que el 90% de nuestros clientes ya regularizan su deuda a través de este enlace seguro, porque evita hacer colas en el banco y el descuento se aplica automáticamente. Es lo que todos prefieren hoy.", keywords: ["normal", "precaución", "clientes", "regularizan", "enlace", "seguro", "colas", "prefieren"], s: "Técnica de Consenso" },
            { t: "Consenso 3", c: "Mito de esperar", q: "Voy a esperar un tiempo más a ver si el banco me borra la deuda solo.", a: "Ese es un mito muy común. La gran mayoría de personas que decide esperar, termina enfrentando procesos de embargo o retenciones de cuentas. Los clientes más inteligentes aprovechan esta etapa preventiva para liquidar con descuento.", keywords: ["mito", "común", "mayoría", "personas", "esperar", "embargo", "retenciones", "inteligentes"], s: "Técnica de Consenso" },
            { t: "Consenso 4", c: "Sector golpeado", q: "Las ventas en mi negocio están bajísimas, imposible pagar.", a: "Varios comerciantes y emprendedores de su mismo sector nos dijeron lo mismo al principio. Pero vieron que cancelar la deuda les permitió volver a pedir capital de trabajo para reactivar sus negocios. Haga como ellos y libere su crédito.", keywords: ["comerciantes", "emprendedores", "sector", "principio", "cancelar", "capital", "negocios", "libere"], s: "Técnica de Consenso" },
            { t: "Consenso 5", c: "Pagos pequeños", q: "Solo tengo una parte, pero mejor no doy nada hasta tener todo junto.", a: "Casi todos mis clientes creen eso al inicio. Sin embargo, los que logran salvar sus descuentos y evitar intereses extra son los que empiezan con abonos parciales, por más pequeños que sean. Siga el ejemplo de los que ya solucionaron su caso.", keywords: ["casi", "todos", "creen", "salvar", "descuentos", "empiezan", "parciales", "ejemplo", "solucionaron"], s: "Técnica de Consenso" }
        ];

        let currentIndex = -1;
        let recognition;
        let synth = window.speechSynthesis;
        let isTransitioning = false; 
        let isPaused = false;
        let mode = 'reading';
        let isActive = false;
        let stepTranscript = '';
        let pendingTransition = false;

        window.onload = () => {
            renderList();
            initRecognition();
        };

        function setMode(m) {
            mode = m;
            document.getElementById('tabReading').classList.toggle('active', m === 'reading');
            document.getElementById('tabFree').classList.toggle('active', m === 'free');
            if(isActive && !synth.speaking) renderStep();
        }

        function renderList() {
            const list = document.getElementById('objectionList');
            list.innerHTML = persuasionDB.map((obj, i) => `
                <div onclick="selectObjection(${i})" class="obj-list-item" id="item-${i}">
                    <div>
                        <div class="text-[10px] text-purple-400 font-bold mb-1 tracking-widest uppercase">${obj.c}</div>
                        <div class="text-white font-medium text-sm">${obj.t}</div>
                    </div>
                    <i class="fas fa-play-circle text-slate-500 group-hover:text-purple-400"></i>
                </div>
            `).join('');
        }

        function startSystem() {
            isActive = true;
            document.getElementById('btnStart').classList.add('hidden');
            document.getElementById('btnPause').classList.remove('hidden');
            selectObjection(0);
        }

        function togglePause() {
            if (!isActive || currentIndex === -1) return;
            const btn = document.getElementById('btnPause');
            const status = document.getElementById('statusIndicator');

            if (!isPaused) {
                isPaused = true;
                if(synth.speaking) synth.pause();
                if(recognition) recognition.stop();
                
                btn.innerHTML = '<i class="fas fa-play mr-1"></i> CONTINUAR';
                btn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg";
                
                status.className = "text-sm font-mono text-slate-400 flex items-center gap-2 status-paused bg-slate-800 px-3 py-1 rounded-full border border-slate-600";
                status.innerHTML = `<i class="fas fa-pause"></i> ENTRENAMIENTO PAUSADO`;
                document.getElementById('objectionList').style.pointerEvents = 'none';
                document.getElementById('objectionList').style.opacity = '0.5';
            } else {
                isPaused = false;
                btn.innerHTML = '<i class="fas fa-pause mr-1"></i> PAUSAR';
                btn.className = "bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg";
                
                document.getElementById('objectionList').style.pointerEvents = 'auto';
                document.getElementById('objectionList').style.opacity = '1';

                if(synth.paused) {
                    synth.resume();
                    status.className = "text-sm font-mono text-yellow-500 flex items-center gap-2 status-talking bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    status.innerHTML = `<i class="fas fa-volume-up"></i> CLIENTE HABLANDO...`;
                } else if (pendingTransition) {
                    pendingTransition = false;
                    nextObjection();
                } else if (!synth.speaking) {
                    try { recognition.start(); } catch(e) {}
                    status.className = "text-sm font-mono text-purple-400 flex items-center gap-2 status-listening bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    status.innerHTML = `<i class="fas fa-microphone"></i> TU TURNO (APLICA LA TÉCNICA)`;
                }
            }
        }

        function selectObjection(index) {
            if(isPaused) return; 
            isTransitioning = false;
            pendingTransition = false;
            if(recognition) recognition.stop();

            document.querySelectorAll('.obj-list-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`item-${index}`).classList.add('active');
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('botArea').classList.remove('hidden');
            document.getElementById('userArea').classList.add('hidden'); 
            document.getElementById('micHint').innerHTML = '<i class="fas fa-microphone text-purple-500"></i> Lee en voz alta para avanzar';

            currentIndex = index;
            document.getElementById('counter').innerText = index + 1;
            const data = persuasionDB[index];

            document.getElementById('strategyDisplay').innerHTML = `<span class="strategy-badge"><i class="fas fa-bolt text-purple-400 mr-1"></i> ${data.s}</span>`;
            document.getElementById('botText').innerText = `"${data.q}"`;
            
            playBotAudio(data.q);
        }

        function renderStep() {
            const data = persuasionDB[currentIndex];
            let text = data.a;
            
            if (mode === 'free') {
                text = `<span class="text-slate-300 italic text-lg"><i class="fas fa-microphone-alt text-purple-400"></i> Aplica la técnica de persuasión con tus propias palabras.</span><br><br><span class="text-xs text-purple-300 font-normal">Palabras clave esperadas: ${data.keywords.join(', ')}</span>`;
                document.getElementById('userLabel').innerText = "Objetivo Persuasivo:";
                document.getElementById('advisorBox').className = "user-bubble shadow-xl border-dashed border-2 border-purple-500 bg-slate-800";
            } else {
                text = `"${text}"`;
                document.getElementById('userLabel').innerText = "Tu Respuesta Sugerida:";
                document.getElementById('advisorBox').className = "user-bubble shadow-xl";
            }
            document.getElementById('advisorText').innerHTML = text;
        }

        function playBotAudio(text) {
            if(synth.speaking) synth.cancel();
            
            const status = document.getElementById('statusIndicator');
            status.className = "text-sm font-mono text-yellow-500 flex items-center gap-2 status-talking bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
            status.innerHTML = `<i class="fas fa-volume-up"></i> CLIENTE HABLANDO...`;

            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'es-US'; utter.rate = 1.1;

            utter.onend = () => {
                if(isPaused) return; 

                renderStep();
                document.getElementById('userArea').classList.remove('hidden');
                status.className = "text-sm font-mono text-purple-400 flex items-center gap-2 status-listening bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                status.innerHTML = `<i class="fas fa-microphone"></i> TU TURNO (APLICA LA TÉCNICA)`;
                
                stepTranscript = '';
                setTimeout(() => { try { recognition.start(); } catch(e) {} }, 500);
            };

            synth.speak(utter);
        }

        function replayBot() {
            if(currentIndex >= 0 && !isPaused) playBotAudio(persuasionDB[currentIndex].q);
        }

        function initRecognition() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return;
            
            recognition = new Speech();
            recognition.lang = 'es-PE';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                if(isTransitioning || isPaused) return;

                let transcript = '';
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        transcript = event.results[i][0].transcript;
                        stepTranscript += transcript + " ";
                        isFinal = true;
                    }
                }

                if (isFinal && transcript.trim().length > 15) {
                    isTransitioning = true;
                    recognition.stop(); 

                    const hint = document.getElementById('micHint');
                    hint.innerHTML = `<span class='text-purple-400 font-bold'><i class="fas fa-check"></i> Técnica Detectada. Avanzando...</span>`;
                    
                    document.getElementById('statusIndicator').className = "text-sm font-mono text-blue-400 flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700";
                    document.getElementById('statusIndicator').innerHTML = `<i class="fas fa-spinner fa-spin"></i> PROCESANDO...`;

                    setTimeout(() => {
                        if(!isPaused) {
                            nextObjection();
                        } else {
                            pendingTransition = true;
                        }
                    }, 2000);
                    
                } else if (!isFinal) {
                    document.getElementById('micHint').innerHTML = "<span class='text-yellow-400'><i class='fas fa-assistive-listening-systems'></i> Escuchando...</span>";
                }
            };
            
            recognition.onend = () => {
                if (!isTransitioning && !isPaused && currentIndex !== -1 && !synth.speaking && isActive) {
                    try { recognition.start(); } catch(e) {}
                }
            };
        }

        function nextObjection() {
            if(isPaused) return;
            let next = currentIndex + 1;
            if(next >= persuasionDB.length) {
                alert("¡Excelente trabajo! Has completado las 30 prácticas de persuasión de Cialdini.");
                next = 0; 
                isActive = false;
                document.getElementById('btnStart').classList.remove('hidden');
                document.getElementById('btnPause').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                document.getElementById('botArea').classList.add('hidden');
                document.getElementById('userArea').classList.add('hidden');
                return;
            }
            
            selectObjection(next);
            const item = document.getElementById(`item-${next}`);
            if(item) item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

    </script>
</body>
</html>